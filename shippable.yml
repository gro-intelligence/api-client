language: python

python:
  - 2.7
  - 3.7

branches:
  except:
    - gh-pages

env:
  - GROAPI_TOKEN=dummytoken

build:
  cache: true
  cache_dir_list:
    - /root/.cache/pip
  ci:
    - shippable_retry pip install .[test]
    # Run doctests
    - python groclient/lib.py -v
    # Create folders for test and code coverage
    - mkdir -p shippable/testresults
    - mkdir -p shippable/codecoverage
    # Run test and code coverage and output results to the right folder
    - >
      pytest
      --junitxml=shippable/testresults/nosetests.xml
      --cov=groclient
      --cov-report=xml:shippable/codecoverage/coverage.xml
    - >
      if [ "$SHIPPABLE_PYTHON_VERSION" == "3.7" ]; then
        shippable_retry pip install -r api/client/samples/analogous_years/requirements.txt && pytest api/client/samples/analogous_years/
      fi;
  on_success:
    # Only build docs on the Python 2.7 run. It is unnecessary to run on both 2.x and 3.x - one or
    # the other should suffice. However, as of this writing
    # https://github.com/sphinx-contrib/sphinxcontrib-versioning does not support the latest 3.x
    # versions, which we do want to run unit tests on. That is why 2.x is used, rather than adding
    # an older 3.x version to the build matrix just to support docs.
    #
    # 2020-10-21 update: sphinxcontrib-versioning is nondeterministically
    # throwing UnicodeDecode errors, preventing PRs from being merged. While
    # the library claims to only support up to Python 3.5, it also hasn't been
    # updated since 2016. It works while manually testing with Python 3.7, so
    # we're using 3.7 via Shippable to avoid the UnicodeDecode errors.
    - >
      if [ "$SHIPPABLE_PYTHON_VERSION" == "3.7" ]; then
        shippable_retry pip install .[docs] &&
        git config --global user.email "api-documentation@gro-intelligence.com" &&
        git config --global user.name "Gro Intelligence" &&
        git remote set-url origin git@github.com:$REPO_FULL_NAME.git &&
        ssh-agent bash -c 'ssh-add /tmp/ssh/00_sub; sphinx-versioning push -r development docs gh-pages .';
      fi;
